# 安邦智库简报生成系统 (ANBOUND Brief Generator)

## 项目概述

安邦智库简报生成系统是一个基于大语言模型的智能新闻简报生成工具，专门为安邦智库（ANBOUND）设计。该系统能够自动处理新闻文本，生成符合安邦智库写作风格的专业简报，并通过向量化技术匹配历史文章，确保内容的一致性和专业性。

## 核心特性

- **智能文本解读**：自动解析新闻源文本，提取关键信息和分析要点
- **历史文章匹配**：基于向量化技术匹配相关历史文章，保持风格一致性
- **多轮内容优化**：通过多个AI模块协作，逐步完善简报内容和标题
- **专业写作规范**：严格遵循安邦智库的写作风格和逻辑连接词体系
- **并行处理能力**：支持批量处理多个新闻文件，提高工作效率
- **质量控制机制**：内置多层审核和优化流程，确保输出质量
- **统一迭代管理**：智能迭代计数和状态跟踪，防止无限循环
- **精确长度控制**：574字符标准的三级梯度校验机制
- **全面监控系统**：LLM调用监控、性能分析和错误追踪
- **任务隔离机制**：独立的测试环境和数据隔离保护

## 系统架构

### 核心工作流程

```
输入文件 (inputs/*.txt)
    ↓
1. 文本解读 (a_interpret_source_text)
    ↓
2. 历史文章匹配 (embedding.py + reference_text.csv)
    ↓
3. 简报内容生成 (b_draft_brief_content)
    ↓
4. 内容审核优化 (c_review_brief_content)
    ↓
5. 句子级审核 (d_review_brief_sentences)
    ↓
6. 内容精炼 (e_refine_brief_content)
    ↓
7. 标题生成 (g_draft_brief_title)
    ↓
8. 标题审核 (h_review_brief_title)
    ↓
9. 标题优化 (i_refine_brief_title)
    ↓
10. 长度调整 (k_adjust_length)
    ↓
输出文件 (outputs/*.txt)
```

### 模块架构

#### 1. 主控制器 (`workflow.py`)
- **功能**：协调整个简报生成流程
- **特点**：支持并行处理多个文件，异步执行提高效率
- **流程管理**：10步完整工作流，确保每个环节质量可控
- **迭代管理**：集成统一迭代管理器，智能控制宏观和微观审查轮次
- **状态跟踪**：实时监控工作流各阶段状态和迭代进度

#### 2. 工具函数库 (`utils.py`)
- **LLM调用**：支持OpenRouter API和本地Ollama模型
- **文本处理**：XML标签提取、JSON解析、文本转换等
- **术语标准化**：繁简转换、专业术语统一
- **日期处理**：智能日期识别和格式化
- **长度校验**：574字符标准的精确长度控制系统
- **字符统计**：多模式字符计算（字符模式、字数模式、语义模式）

#### 3. 向量化引擎 (`embedding.py`)
- **文本向量化**：使用阿里云DashScope的text-embedding-v4模型
- **相似度匹配**：基于FAISS的高效向量检索
- **历史文章库**：维护和更新参考文章向量索引
- **标签处理**：多维度标签向量化和匹配

#### 4. 提示词系统 (`prompts/`)
每个提示词模块都经过精心设计，确保输出质量：

- **a_interpret_source_text.py**：新闻文本解读和关键信息提取
- **b_draft_brief_content.py**：基于风格参考生成初版简报内容
- **c_review_brief_content.py**：内容层面的质量审核和反馈
- **d_review_brief_sentences.py**：句子级别的语言和逻辑审核
- **e_refine_brief_content.py**：基于反馈的内容精炼和优化
- **g_draft_brief_title.py**：简报标题生成
- **h_review_brief_title.py**：标题质量审核
- **i_refine_brief_title.py**：标题优化和完善
- **k_adjust_length.py**：内容长度智能调整

#### 5. 迭代管理系统 (`iteration_manager.py`)
- **统一计数**：宏观、微观、标题审查的统一迭代管理
- **状态跟踪**：工作流各阶段状态的实时监控
- **防护机制**：防止无限循环和计数错误
- **历史记录**：完整的迭代历史和决策轨迹

#### 6. 长度跟踪系统 (`length_tracker.py`)
- **精确校验**：574字符标准的三级梯度校验
- **统计分析**：详细的长度变化趋势分析
- **动态反馈**：基于长度状态的智能修改建议
- **历史追踪**：完整的长度校验历史记录

#### 7. LLM监控系统 (`llm_monitor.py`)
- **调用监控**：实时监控所有LLM API调用
- **性能分析**：响应时间、成功率、错误率统计
- **成本控制**：Token使用量和成本分析
- **错误追踪**：详细的错误日志和异常处理

## 技术栈

### 核心依赖
- **Python 3.13+**：主要开发语言
- **OpenAI 1.98.0**：大语言模型API调用
- **aiohttp 3.12.13**：异步HTTP客户端
- **numpy 2.3.1**：数值计算
- **pandas 2.3.1**：数据处理
- **faiss-cpu 1.11.0**：向量检索
- **tqdm 4.67.1**：进度显示

### AI模型支持
- **主要模型**：通过OpenRouter调用qwen/qwen3-235b-a22b-2507
- **向量化模型**：阿里云DashScope text-embedding-v4
- **本地支持**：Ollama本地模型（可选）

## 安装和使用

### 环境准备

1. **创建虚拟环境**
```bash
python -m venv venv
```

2. **激活虚拟环境**
```bash
# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate
```

3. **安装依赖**
```bash
pip install -r requirements.txt
```

### 配置API密钥

在 `utils.py` 和 `embedding.py` 中配置相应的API密钥：
- OpenRouter API Key (用于LLM调用)
- DashScope API Key (用于向量化)

### 使用方法

1. **准备输入文件**
   - 将待处理的新闻文本放入 `inputs/` 目录
   - 文件格式：`.txt`，编码：UTF-8

2. **运行简报生成**
```bash
python workflow.py
```

3. **查看输出结果**
   - 生成的简报保存在 `outputs/` 目录
   - 文件名格式：`{原文件名} with matched briefs_{随机数}.txt`

## 核心算法

### 1. 语义匹配算法
- 使用1024维向量表示文本语义
- 基于余弦相似度计算文章相关性
- 动态阈值调整，确保匹配质量

### 2. 内容生成策略
- **风格学习**：从历史文章中学习写作模式
- **逻辑连接**：六大类逻辑连接词体系
- **长度控制**：智能调整内容长度（500-800字符）

### 3. 质量保证机制
- **多轮审核**：内容、句子、标题三级审核
- **事实核查**：确保信息准确性和完整性
- **风格一致性**：保持安邦智库专业风格

## 逻辑连接词体系

系统采用安邦智库专用的六大类逻辑连接词体系：

1. **时间顺序连接词**：体现事件发展的时间脉络
2. **因果逻辑连接词**：建立清晰的因果关系链
3. **对比转折连接词**：突出不同观点和情况对比
4. **递进补充连接词**：逐层深入分析问题
5. **引用观点连接词**：规范引用权威观点和数据
6. **总结展望连接词**：提供总结性观点和未来展望

## 项目结构

```
briefgenerator-main/
├── workflow.py              # 主工作流控制器
├── utils.py                 # 工具函数库
├── embedding.py             # 向量化和匹配引擎
├── iteration_manager.py     # 统一迭代管理系统
├── length_tracker.py        # 长度跟踪和校验系统
├── llm_monitor.py          # LLM调用监控系统
├── task_isolation.py       # 任务隔离和测试支持
├── requirements.txt         # 项目依赖
├── reference_text.csv       # 历史文章参考库
├── all_tag_vecs.txt        # 标签向量缓存
├── inputs/                  # 输入文件目录
│   └── *.txt               # 待处理的新闻文本
├── outputs/                 # 输出文件目录
│   └── *.txt               # 生成的简报文件
├── logs/                    # 日志文件目录
│   └── llm_monitor.log     # LLM监控日志
├── test_logs/              # 测试日志目录
│   ├── *.json              # 测试报告
│   └── *.txt               # 测试摘要
├── test_data/              # 测试数据目录
│   ├── reports/            # 测试报告
│   ├── sessions/           # 测试会话
│   └── steps/              # 测试步骤
├── prompts/                 # 提示词模块
│   ├── a_interpret_source_text.py
│   ├── b_draft_brief_content.py
│   ├── c_review_brief_content.py
│   ├── d_review_brief_sentences.py
│   ├── e_refine_brief_content.py
│   ├── g_draft_brief_title.py
│   ├── h_review_brief_title.py
│   ├── i_refine_brief_title.py
│   ├── k_adjust_length.py
│   └── l_translate_to_other_languages.py
├── prompt_panlin/           # 额外提示词模块
│   ├── first_sentence_draft.py
│   └── fact_paragraph_draft.py
├── tests/                   # 测试文件
│   ├── test_*.py           # 单元测试
│   ├── conftest.py         # 测试配置
│   └── test_data/          # 测试数据
├── jiqi/                    # 机器相关模块
└── venv/                    # 虚拟环境
```

## 性能特点

- **并行处理**：支持同时处理多个新闻文件
- **异步执行**：使用asyncio提高I/O效率
- **错误恢复**：内置重试机制，提高系统稳定性
- **内存优化**：流式处理大文件，避免内存溢出
- **缓存机制**：向量化结果缓存，减少重复计算
- **智能迭代**：统一迭代管理，防止无限循环和资源浪费
- **实时监控**：LLM调用性能监控和成本控制
- **任务隔离**：独立的测试环境，保护生产数据

## 质量控制

### 内容质量标准
- **准确性**：确保所有事实信息准确无误
- **完整性**：包含新闻事件的核心要素
- **专业性**：符合安邦智库的分析深度要求
- **可读性**：语言流畅，逻辑清晰
- **长度精确**：574字符标准的三级梯度校验

### 技术质量保证
- **代码规范**：遵循PEP 8编码标准
- **错误处理**：完善的异常处理机制
- **日志记录**：详细的执行日志，便于调试
- **测试覆盖**：关键功能单元测试
- **迭代控制**：智能迭代管理，防止系统异常
- **性能监控**：全面的LLM调用和系统性能监控
- **数据隔离**：测试环境与生产环境完全隔离

## 扩展性设计

- **模块化架构**：各功能模块独立，便于维护和扩展
- **配置化管理**：支持灵活的参数配置
- **多模型支持**：可轻松切换不同的AI模型
- **多语言支持**：预留国际化接口
- **插件化设计**：支持自定义提示词和处理逻辑
- **监控扩展**：可扩展的监控指标和报警机制
- **测试框架**：完整的测试基础设施，支持持续集成

## 开发团队

本项目由安邦智库技术团队开发维护，专注于为智库研究提供AI技术支持。

## 技术亮点

### 1. 统一迭代管理架构
- **问题解决**：解决了原有系统中迭代计数混乱、状态管理分散的问题
- **核心特性**：统一的迭代计数、阶段状态跟踪、迭代验证和限制
- **防护机制**：防止无限循环，确保系统稳定性

### 2. 精确长度控制系统
- **574字符标准**：目标475字符，容忍度50字符的精确控制
- **三级梯度校验**：强制修正区、建议优化区、理想区的智能判断
- **多模式计算**：支持字符模式、字数模式、语义模式的灵活切换

### 3. 全面监控体系
- **LLM调用监控**：实时监控API调用状态、响应时间、成功率
- **成本控制**：Token使用量统计和成本分析
- **性能分析**：详细的性能指标和趋势分析

### 4. 企业级测试框架
- **任务隔离**：完全隔离的测试环境，保护生产数据
- **数据管理**：独立的测试数据存储和管理
- **自动化测试**：完整的单元测试和集成测试覆盖

## 版本信息

- **当前版本**：v3.0
- **最后更新**：2025年1月
- **Python版本要求**：3.13+
- **主要依赖版本**：OpenAI 1.98.0, aiohttp 3.12.13
- **新增模块**：iteration_manager.py, length_tracker.py, llm_monitor.py, task_isolation.py

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

---

*本系统专为安邦智库定制开发，体现了AI技术在智库研究中的创新应用。*